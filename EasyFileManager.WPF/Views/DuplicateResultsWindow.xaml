<Window x:Class="EasyFileManager.WPF.Views.DuplicateResultsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:EasyFileManager.WPF.ViewModels"
        Title="Duplicate Files" 
        Height="700" 
        Width="1000"
        MinHeight="500"
        MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Style="{StaticResource MaterialDesignWindow}"
        Background="{DynamicResource MaterialDesignPaper}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" MinWidth="400"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="1*" MinWidth="300"/>
        </Grid.ColumnDefinitions>

        <!-- Title Bar -->
        <materialDesign:ColorZone Grid.Row="0" 
                               Grid.ColumnSpan="3"
                               Mode="PrimaryMid" 
                               Padding="16"
                               materialDesign:ElevationAssist.Elevation="Dp4">
            <DockPanel>
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="FileFind" 
                                             Width="32" 
                                             Height="32" 
                                             VerticalAlignment="Center"
                                             Margin="0,0,12,0"/>
                    <TextBlock Text="Duplicate Files" 
                               VerticalAlignment="Center"
                               Style="{StaticResource MaterialDesignHeadline5TextBlock}"/>
                </StackPanel>

                <Button Content="CLOSE"
                        Click="CloseButton_Click"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        HorizontalAlignment="Right"
                        DockPanel.Dock="Right"/>
            </DockPanel>
        </materialDesign:ColorZone>

        <!-- Statistics Panel -->
        <Border Grid.Row="1" 
                Grid.ColumnSpan="3"
            Background="{DynamicResource MaterialDesignToolBarBackground}"
            Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Total Groups -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="Duplicate Groups"
                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                               Opacity="0.7"/>
                    <TextBlock Text="{Binding TotalGroups}"
                               Style="{StaticResource MaterialDesignHeadline4TextBlock}"/>
                </StackPanel>

                <!-- Total Files -->
                <StackPanel Grid.Column="1">
                    <TextBlock Text="Duplicate Files"
                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                               Opacity="0.7"/>
                    <TextBlock Text="{Binding TotalDuplicateFiles}"
                               Style="{StaticResource MaterialDesignHeadline4TextBlock}"/>
                </StackPanel>

                <!-- Wasted Space -->
                <StackPanel Grid.Column="2">
                    <TextBlock Text="Wasted Space"
                               Style="{StaticResource MaterialDesignCaptionTextBlock}"
                               Opacity="0.7"/>
                    <TextBlock Text="{Binding TotalWastedSpaceFormatted}"
                               Style="{StaticResource MaterialDesignHeadline4TextBlock}"
                               Foreground="Red"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Duplicate Groups List -->
        <ScrollViewer Grid.Row="2" 
                      Grid.Column="0"
                      VerticalScrollBarVisibility="Auto"
                      Padding="16">
            <ItemsControl ItemsSource="{Binding Groups}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <materialDesign:Card Margin="0,0,0,16"
                                             materialDesign:ElevationAssist.Elevation="Dp2">
                            <Expander IsExpanded="{Binding IsExpanded}">
                                <!-- Group Header -->
                                <Expander.Header>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <materialDesign:PackIcon Kind="FileMultiple"
                                                                 Grid.Column="0"
                                                                 Width="24"
                                                                 Height="24"
                                                                 VerticalAlignment="Center"
                                                                 Margin="0,0,12,0"/>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Style="{StaticResource MaterialDesignBody1TextBlock}"
                                                       FontWeight="SemiBold">
                                                <Run Text="{Binding FileCount, Mode=OneWay}"/>
                                                <Run Text="copies"/>
                                                <Run Text="•"/>
                                                <Run Text="{Binding SizeFormatted, Mode=OneWay}"/>
                                                <Run Text="each"/>
                                            </TextBlock>
                                            <TextBlock Text="{Binding TotalWastedSpaceFormatted, StringFormat='Wasted: {0}'}"
                                                       Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                       Foreground="Red"
                                                       Opacity="0.9"/>
                                        </StackPanel>

                                        <!-- Quick selection buttons -->
                                        <StackPanel Grid.Column="2" 
                                                    Orientation="Horizontal"
                                                    VerticalAlignment="Center"
                                                    Margin="0,0,16,0">
                                            <Button Content="Keep First"
                                                    Command="{Binding DataContext.SelectAllDuplicatesCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    Height="28"
                                                    Padding="8,4"
                                                    Margin="0,0,4,0"
                                                    ToolTip="Select all except first file"/>
                                            <Button Content="Keep Newest"
                                                    Command="{Binding DataContext.SelectAllExceptNewestCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    Height="28"
                                                    Padding="8,4"
                                                    Margin="0,0,4,0"
                                                    ToolTip="Select all except newest file"/>
                                            <Button Content="Keep Oldest"
                                                    Command="{Binding DataContext.SelectAllExceptOldestCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    Height="28"
                                                    Padding="8,4"
                                                    ToolTip="Select all except oldest file"/>
                                        </StackPanel>
                                    </Grid>
                                </Expander.Header>

                                <!-- Files in Group -->
                                <ItemsControl ItemsSource="{Binding Files}"
                                          Margin="16,8,16,16"
                                          x:Name="FilesItemsControl">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{DynamicResource MaterialDesignDivider}"
                                                BorderThickness="0,0,0,1"
                                                Padding="8"
                                                Margin="0,0,0,4"
                                                Background="Transparent"
                                                MouseDown="FileItem_MouseDown"
                                                Tag="{Binding}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Checkbox -->
                                                    <CheckBox Grid.Column="0"
                                                              IsChecked="{Binding IsSelected}"
                                                              VerticalAlignment="Center"
                                                              Margin="0,0,12,0"
                                                              ToolTip="Select for deletion"/>

                                                    <!-- File Info -->
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding FileName}"
                                                                   Style="{StaticResource MaterialDesignBody1TextBlock}"
                                                                   FontWeight="SemiBold"/>
                                                        <TextBlock Text="{Binding Directory}"
                                                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Opacity="0.7"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   ToolTip="{Binding FullPath}"/>
                                                        <TextBlock Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                                                   Opacity="0.6">
                                                            <Run Text="Modified:"/>
                                                            <Run Text="{Binding LastModifiedFormatted}"/>
                                                        </TextBlock>
                                                    </StackPanel>

                                                    <!-- Actions -->
                                                    <StackPanel Grid.Column="2"
                                                                Orientation="Horizontal"
                                                                VerticalAlignment="Center"
                                                                Margin="8,0">
                                                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                                                Command="{Binding OpenLocationCommand}"
                                                                ToolTip="Open location"
                                                                Width="32"
                                                                Height="32">
                                                            <materialDesign:PackIcon Kind="FolderOpen" Width="20" Height="20"/>
                                                        </Button>
                                                        <Button Style="{StaticResource MaterialDesignIconButton}"
                                                                Command="{Binding CopyPathCommand}"
                                                                ToolTip="Copy path"
                                                                Width="32"
                                                                Height="32">
                                                            <materialDesign:PackIcon Kind="ContentCopy" Width="20" Height="20"/>
                                                        </Button>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>
                        </materialDesign:Card>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Splitter -->
        <GridSplitter Grid.Row="2" 
                  Grid.Column="1"
                  Width="5" 
                  HorizontalAlignment="Stretch"
                  Background="{DynamicResource MaterialDesignDivider}"/>

        <!-- PREVIEW PANEL - RIGHT SIDE -->
        <Border Grid.Row="2" 
            Grid.Column="2"
            Background="{DynamicResource MaterialDesignCardBackground}"
            BorderBrush="{DynamicResource MaterialDesignDivider}"
            BorderThickness="1,0,0,0">
            <Grid>

                <ScrollViewer VerticalScrollBarVisibility="Auto"
                      Padding="16"
                      x:Name="PreviewScrollViewer">
                    <StackPanel x:Name="PreviewPanel"
                        DataContext="{Binding SelectedFile}">

                        <!-- No file selected -->
                        <!--
                    <TextBlock Text="Select a file to preview"
                           Style="{StaticResource MaterialDesignBody1TextBlock}"
                           Opacity="0.5"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Margin="0,100,0,0"
                           Visibility="{Binding Converter={StaticResource NotNullToVisibilityConverter}}"/>-->

                        <!-- File selected - show preview -->
                        <StackPanel Visibility="{Binding Converter={StaticResource NotNullToVisibilityConverter}}" Margin="10">

                            <!-- File Name -->
                            <TextBlock Text="{Binding FileName}" x:Name="TextPreviewPanel"
                               Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                               TextWrapping="Wrap"
                               Margin="0,10,0,16"/>

                            <!-- Loading indicator -->
                            <ProgressBar IsIndeterminate="True"
                                 Visibility="{Binding IsPreviewLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 Margin="0,0,0,16"/>

                            <!-- Image Preview -->
                            <StackPanel Visibility="{Binding PreviewType, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=Image}">
                                <TextBlock Text="Image Preview"
                                   Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                   Margin="0,0,0,8"/>

                                <Image Source="{Binding FullPath}"
                               MaxHeight="300"
                               Stretch="Uniform"
                               Margin="0,0,0,16"/>

                                <!-- Image Metadata -->
                                <StackPanel DataContext="{Binding ImagePreview}"
                                    Visibility="{Binding Converter={StaticResource NotNullToVisibilityConverter}}">
                                    <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                                <Run Text="Resolution:" FontWeight="SemiBold"/>
                                <Run Text="{Binding Resolution, Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                                <Run Text="Format:" FontWeight="SemiBold"/>
                                <Run Text="{Binding Format, Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4"
                                       Visibility="{Binding DateTaken, Converter={StaticResource NotNullToVisibilityConverter}}">
                                <Run Text="Date Taken:" FontWeight="SemiBold"/>
                                <Run Text="{Binding DateTaken, StringFormat='yyyy-MM-dd HH:mm', Mode=OneWay}"/>
                                    </TextBlock>
                                    <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4"
                                       Visibility="{Binding CameraMake, Converter={StaticResource NotNullToVisibilityConverter}}">
                                <Run Text="Camera:" FontWeight="SemiBold"/>
                                <Run Text="{Binding CameraMake, Mode=OneWay}"/>
                                <Run Text="{Binding CameraModel, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>
                            </StackPanel>

                            <!-- Text Preview -->
                            <StackPanel Visibility="{Binding PreviewType, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=Text}">
                                <TextBlock Text="Text Preview"
                                   Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                   Margin="0,0,0,8"/>

                                <Border Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="12"
                                MaxHeight="400"
                                Margin="0,0,0,16">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <TextBlock Text="{Binding TextPreview.Content}"
                                           FontFamily="Consolas"
                                           FontSize="11"
                                           TextWrapping="Wrap"/>
                                    </ScrollViewer>
                                </Border>

                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Lines:" FontWeight="SemiBold"/>
                            <Run Text="{Binding TextPreview.LineCount, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>

                            <!-- Generic File Info -->
                            <StackPanel DataContext="{Binding FileInfo}"
                                Visibility="{Binding Converter={StaticResource NotNullToVisibilityConverter}}">
                                <TextBlock Text="File Information"
                                   Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                   Margin="0,16,0,8"/>

                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Size:" FontWeight="SemiBold"/>
                            <Run Text="{Binding SizeFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Type:" FontWeight="SemiBold"/>
                            <Run Text="{Binding Extension, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Created:" FontWeight="SemiBold"/>
                            <Run Text="{Binding Created, StringFormat='yyyy-MM-dd HH:mm', Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Modified:" FontWeight="SemiBold"/>
                            <Run Text="{Binding Modified, StringFormat='yyyy-MM-dd HH:mm', Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}" Margin="0,4">
                            <Run Text="Read-only:" FontWeight="SemiBold"/>
                            <Run Text="{Binding IsReadOnly, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>

                            <!-- Full Path -->
                            <StackPanel Margin="0,16,0,0">
                                <TextBlock Text="Full Path"
                                   Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                   Margin="0,0,0,4"/>
                                <TextBlock Text="{Binding FullPath}"
                                   Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                   TextWrapping="Wrap"
                                   Opacity="0.7"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Bottom"
                    Margin="0,0,16,16"
                    DataContext="{Binding SelectedFile}"
                    Visibility="{Binding Converter={StaticResource NotNullToVisibilityConverter}}">

                    <!-- Copy Path FAB -->
                    <Button Style="{StaticResource MaterialDesignFloatingActionButton}"
                    Command="{Binding CopyPathCommand}"
                    Width="48"
                    Height="48"
                    Margin="0,0,8,0"
                    ToolTip="Copy path to clipboard"
                    materialDesign:ElevationAssist.Elevation="Dp6">
                        <materialDesign:PackIcon Kind="ContentCopy"
                                         Width="24"
                                         Height="24"/>
                    </Button>

                    <!-- Open Location FAB (Primary) -->
                    <Button Style="{StaticResource MaterialDesignFloatingActionButton}"
                    Command="{Binding OpenLocationCommand}"
                    Width="56"
                    Height="56"
                    Background="{DynamicResource PrimaryHueMidBrush}"
                    Foreground="White"
                    ToolTip="Open folder location"
                    materialDesign:ElevationAssist.Elevation="Dp8">
                        <materialDesign:PackIcon Kind="FolderOpen"
                                         Width="28"
                                         Height="28"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Action Bar -->
        <Border Grid.Row="3"
                Grid.ColumnSpan="3"
                Background="{DynamicResource MaterialDesignToolBarBackground}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,1,0,0"
                Padding="16">
            <DockPanel>
                <!-- Selection Info -->
                <StackPanel DockPanel.Dock="Left" VerticalAlignment="Center">
                    <TextBlock Style="{StaticResource MaterialDesignBody2TextBlock}">
                        <Run Text="Selected:"/>
                        <Run Text="{Binding SelectedFilesCount, Mode=OneWay}"/>
                        <Run Text="files"/>
                        <Run Text="•"/>
                        <Run Text="{Binding SelectedFilesSizeFormatted, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            DockPanel.Dock="Right">
                    <Button Content="DESELECT ALL"
                            Command="{Binding DeselectAllCommand}"
                            Style="{StaticResource MaterialDesignFlatButton}"
                            Margin="0,0,8,0"/>
                    <Button Command="{Binding DeleteSelectedCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Foreground="{DynamicResource MaterialDesignBody}"
                            Background="{DynamicResource ValidationErrorBrush}">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Delete"
                                                         Width="20"
                                                         Height="20"
                                                         VerticalAlignment="Center"
                                                         Margin="0,0,8,0"/>
                                <TextBlock Text="DELETE SELECTED" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button.Content>
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</Window>